# 金融词根翻译系统 - 技术架构说明

## 项目概述

金融词根翻译系统是一个基于 Wails 框架构建的桌面应用程序，用于将中文金融术语翻译成英文，支持词根库管理和批量翻译功能。

## 技术栈

### 前端技术栈
- **框架**: React + TypeScript
- **构建工具**: Vite + Bun
- **样式**: Tailwind CSS
- **图标**: Lucide React
- **开发语言**: TypeScript

### 后端技术栈
- **框架**: Wails v2 (Go)
- **数据库**: SQLite3
- **开发语言**: Go 1.23

### 核心依赖
- `github.com/wailsapp/wails/v2` - Wails 框架
- `github.com/mattn/go-sqlite3` - SQLite3 数据库驱动

## 项目结构

```
rootify-wails-app/
├── backend/             # 后端 Go 代码
│   ├── app/            # 应用层 - Wails 绑定接口
│   │   └── app.go      # App 结构体（保持方法签名不变）
│   ├── repository/     # 数据访问层
│   │   └── word_root.go # 词根数据操作
│   ├── service/        # 业务逻辑层
│   │   └── translation.go # 文本分割和翻译逻辑
│   └── models/         # 数据模型
│       └── word_root.go # 词根模型定义
├── frontend/           # 前端源码
│   ├── src/
│   │   ├── components/  # React 组件
│   │   │   ├── common/  # 通用组件
│   │   │   ├── translation/  # 翻译模块
│   │   │   ├── management/   # 管理模块
│   │   │   └── shared/      # 共享组件
│   │   ├── hooks/       # 自定义 Hooks
│   │   ├── services/    # 服务层
│   │   ├── App.tsx      # 主应用组件
│   │   ├── main.tsx     # 前端入口点
│   │   └── index.css    # 样式文件
│   ├── wailsjs/         # Wails 生成的 API 绑定
│   │   ├── go/app/App.d.ts  # TypeScript 类型定义
│   │   └── runtime/     # Wails 运行时 API
│   └── package.json     # 前端依赖配置
├── main.go             # 应用入口点（必须保留在根目录）
├── wails.json          # Wails 配置文件
├── go.mod             # Go 模块配置
├── go.sum             # Go 模块校验
└── docs/              # 技术文档
```

## 核心功能实现

### 1. 数据库层实现

**位置**: `backend/app/app.go` 中的 `initDB()` 方法

**实现细节**:
- 使用 SQLite3 数据库存储词根数据
- 数据库文件存储在应用数据目录下的 `rootify.db`
- 表结构：
  ```sql
  CREATE TABLE word_roots (
      chinese TEXT PRIMARY KEY,
      english TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );
  ```
- 为中文字段创建索引以提高查询性能

### 2. 词根管理功能

#### 2.1 获取所有词根
- **位置**: `backend/app/app.go` 中的 `GetAllRoots()` 方法
- **实现**: 从数据库查询所有词根，返回 `map[string]string` 格式
- **调用路径**: 前端 `App.tsx:18` → `GoAPI.GetAllRoots()`

#### 2.2 添加词根
- **位置**: `backend/app/app.go` 中的 `AddRoot()` 方法
- **实现**: 使用 `INSERT OR REPLACE` 语句，支持更新现有词根
- **调用路径**: 前端 `App.tsx:532` → `GoAPI.AddRoot()`

#### 2.3 批量导入
- **位置**: `backend/app/app.go` 中的 `ImportRoots()` 方法
- **实现**: 使用事务批量导入，确保数据一致性
- **调用路径**: 前端 `App.tsx:28` → `GoAPI.ImportRoots()`

#### 2.4 导出功能
- **位置**: `backend/app/app.go` 中的 `ExportRoots()` 方法
- **实现**: 生成 CSV 格式数据，包含标题行
- **调用路径**: 前端 `App.tsx:186` → `GoAPI.ExportRoots()`

### 3. 文本分词与翻译功能

#### 3.1 文本分词
- **位置**: `backend/app/app.go` 中的 `SegmentText()` 方法
- **算法**: 最长匹配算法，最多匹配10个字符
- **实现细节**:
  - 从左到右扫描文本
  - 尝试匹配最长可能的词根（1-10个字符）
  - 未匹配字符标记为未知
  - 正确处理 UTF-8 字符

#### 3.2 文本翻译
- **位置**: `backend/app/app.go` 中的 `TranslateText()` 方法
- **实现**: 基于分词结果，用下划线连接翻译结果
- **输出格式**: `translated_word1_translated_word2_unknown_char`

### 4. 前端架构

#### 4.1 组件化架构设计
**核心原则**: 单一职责、模块化、可复用

**架构层次**:
```
App.tsx (根组件)
├── Header (应用头部)
├── Navigation (侧边导航)
└── 内容区域
    ├── TranslationPage (翻译页面)
    │   ├── InputArea (输入区域)
    │   ├── TranslationTable (翻译表格)
    │   └── CustomRootForm (自定义词根表单)
    └── ManagementPage (管理页面)
        ├── RootTable (词根表格)
        ├── ImportDialog (导入对话框)
        └── EditDialog (编辑对话框)
```

#### 4.2 状态管理架构
**Hook 模式**:
- `useRoots`: 词根数据管理
- `useTranslation`: 翻译功能状态管理
- `useClipboard`: 剪贴板功能

**服务层**:
- `services/api.ts`: API 调用封装
- `services/csv.ts`: CSV 处理工具

#### 4.3 组件通信模式
- **Props 传递**: 父组件向子组件传递数据和回调
- **Hook 状态**: 使用自定义 Hook 封装复杂逻辑
- **服务层**: 统一管理 API 调用和工具函数

#### 4.4 用户界面功能
- **标签页系统**: 翻译界面 vs 管理界面
- **批量翻译**: 支持多行输入和批量处理
- **实时预览**: 翻译结果实时显示
- **数据导出**: TSV 格式导出到剪贴板

#### 4.5 词根管理界面
- **搜索功能**: 支持中文和英文搜索
- **批量操作**: CSV 导入/导出
- **编辑功能**: 支持单个词根的编辑和删除
- **确认机制**: 重要操作有确认对话框

## 前后端通信机制

### Wails 绑定系统

**生成位置**: `frontend/wailsjs/go/app/App.d.ts`

**可用 API**:
```typescript
export function AddRoot(arg1:string, arg2:string): Promise<void>;
export function GetAllRoots(): Promise<Record<string, string>>;
export function SegmentText(arg1:string): Promise<Array<Record<string, any>>>;
export function TranslateText(arg1:string): Promise<string>;
// ... 其他方法
```

**调用示例** (App.tsx:18):
```typescript
import * as GoAPI from "../wailsjs/go/app/App";

// 调用后端方法
const roots = await GoAPI.GetAllRoots();
```

### 数据流

1. **初始化**: 应用启动时加载词根数据
2. **用户交互**: 前端调用对应 Go 方法
3. **数据处理**: Go 后端操作数据库并返回结果
4. **UI 更新**: 前端根据返回数据更新界面

## 核心算法解析

### 分词算法

**核心逻辑**:
```go
for i < len(text) {
    matched := false

    // 尝试匹配最长可能的词根（最多10个字符）
    for length := min(10, len(text)-i); length >= 1; length-- {
        substring := text[i : i+length]
        if english, exists := roots[substring]; exists {
            // 找到匹配，添加到结果
            i += length
            matched = true
            break
        }
    }

    if !matched {
        // 未匹配字符，按单个字符处理
        runeValue, size := utf8.DecodeRuneInString(text[i:])
        i += size
    }
}
```

**特点**:
- 时间复杂度: O(n*m)，其中 n 是文本长度，m 是最大匹配长度(10)
- 空间复杂度: O(k)，k 是分词结果数量
- 支持 UTF-8 字符正确处理

## 数据存储设计

### 数据库表设计

**word_roots 表**:
| 字段名 | 类型 | 说明 |
|--------|------|------|
| chinese | TEXT PRIMARY KEY | 中文词根，主键 |
| english | TEXT NOT NULL | 英文对应翻译 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

**索引**:
- `idx_chinese`：中文字段索引，加速查询

### 数据持久化策略
- 使用 SQLite 事务确保数据一致性
- 自动维护创建和更新时间戳
- 支持批量操作的原子性

## 性能优化

### 前端优化
- 使用 React 虚拟化技术处理大量数据
- 防抖搜索输入
- 懒加载词根数据
- 组件化架构提高代码复用性和维护性
- 服务层统一管理 API 调用，减少重复代码

### 后端优化
- 数据库查询使用索引
- 内存中缓存词根数据（通过 GetAllRoots 缓存）
- 使用读写锁保护并发访问

## 错误处理机制

### 前端错误处理
- 异步操作使用 try-catch
- 用户友好的错误提示
- 网络请求失败的重试机制

### 后端错误处理
- 数据库操作错误返回具体信息
- 参数验证和边界检查
- 事务回滚机制

## 部署与构建

### 开发环境
```bash
# 启动开发服务器
wails dev

# 构建生产版本
wails build
```

### 构建配置 (wails.json)
- 应用名称: "金融词根翻译器"
- 窗口尺寸: 1024x768
- 前端构建命令: `bun run build`
- 开发服务器: 自动检测

## 扩展性考虑

### 可扩展的功能
1. **词根分类**: 支持按领域分类词根
2. **翻译规则**: 支持自定义翻译规则
3. **多语言支持**: 扩展支持其他语言
4. **云端同步**: 词根库云端备份和同步

### 技术扩展点
1. **插件系统**: 支持翻译算法插件
2. **API 扩展**: 提供 REST API 接口
3. **数据库迁移**: 支持数据库版本升级

## 总结

金融词根翻译系统采用了现代化的桌面应用架构，结合了 Go 的高性能和 React 的丰富交互体验。系统设计注重用户体验和数据管理，提供了完整的词根生命周期管理功能。技术实现上采用了成熟稳定的技术栈，确保了应用的可靠性和可维护性。