# 金融词根翻译系统 - 功能链路说明

## 功能模块概览

本系统包含三大核心功能模块：
1. **词根翻译模块** - 批量翻译中文金融术语
2. **词根管理模块** - 词根库的增删改查和导入导出
3. **翻译历史模块** - 保存、管理和复用翻译历史记录

## 核心功能链路详解

### 1. 批量翻译功能链路

#### 1.1 用户输入处理
**文件位置**: `frontend/src/hooks/useTranslation.ts` - `handleUnifiedInput` 函数

**实现逻辑**:
```typescript
const handleUnifiedInput = (value: string) => {
    setUnifiedInput(value);

    if (value.trim()) {
        const lines = value.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        const newData = lines.map(line => ({ chinese: line, english: "" }));
        setTableData(newData);
    } else {
        setTableData([]);
    }
};
```

**数据流**:
用户输入 → 按行分割 → 过滤空行 → 初始化表格数据

#### 1.2 批量翻译执行
**文件位置**: `frontend/src/components/translation/TranslationPage.tsx` - `handleBatchTranslate` 函数

**调用链路**:
```
前端 `handleBatchTranslate` → services/api.ts → GoAPI.TranslateText() → 后端 `TranslateText()` → `SegmentText()`
```

**详细流程**:
1. 前端遍历表格中的每一行中文文本
2. 对每行文本调用 `translateText()` API服务
3. 后端执行分词和翻译算法
4. 返回翻译结果更新前端界面

#### 1.3 翻译结果显示
**文件位置**: `frontend/src/components/shared/MixedTranslation.tsx` - `MixedTranslation` 组件

**组件**: `MixedTranslation` 组件
**功能**: 实时显示翻译结果，绿色表示已翻译，红色表示未翻译

### 2. 词根管理功能链路

#### 2.1 词根数据加载
**文件位置**: `frontend/src/hooks/useRoots.ts` - `useRoots` Hook

**调用链路**:
```
前端 useRoots() → services/api.ts → GoAPI.GetAllRoots() → 后端 app.go:68 → 数据库查询
```

**数据流**:
应用启动 → 加载词根数据 → 缓存到前端状态 → 渲染界面

#### 2.2 添加单个词根
**文件位置**: `frontend/src/components/translation/TranslationPage.tsx` - `handleAddCustomRoot` 函数

**调用链路**:
```
前端 handleAddCustomRoot() → services/api.ts → GoAPI.AddRoot() → 后端 app.go:95 → 数据库插入
```

**特殊处理**: 添加词根后自动重新翻译所有文本

#### 2.3 批量导入词根
**文件位置**: `frontend/src/components/management/ManagementPage.tsx` - `handleFileUpload` 函数

**完整流程**:
1. 用户选择 CSV 文件
2. 前端解析 CSV 内容 (`services/csv.ts` - `parseCSVContent`)
3. 显示导入预览对话框 (`ImportDialog` 组件)
4. 用户确认后调用 `services/api.ts` - `importRoots()`
5. 后端使用事务批量插入数据

#### 2.4 词根编辑功能
**文件位置**: `frontend/src/components/management/ManagementPage.tsx` - `handleSaveEdit` 函数

**特殊逻辑**:
- 如果修改了中文词根，先删除旧的再添加新的
- 确保数据一致性

### 3. 数据导出功能链路

#### 3.1 词根库导出
**文件位置**: `frontend/src/components/management/ManagementPage.tsx` - `handleExportCSV` 函数

**调用链路**:
```
前端 handleExportCSV() → services/api.ts → GoAPI.ExportRoots() → 后端 app.go:180 → 生成CSV
```

**实现细节**:
- 后端生成标准 CSV 格式
- 前端创建 Blob 对象并提供下载 (`services/csv.ts` - `downloadCSVFile`)

#### 3.2 翻译结果导出
**文件位置**: `frontend/src/components/translation/TranslationPage.tsx` - `handleExportTSV` 函数

**格式**: TSV (Tab-Separated Values)
**用途**: 方便粘贴到 Excel
**实现**: 使用 `services/csv.ts` - `copyToClipboard` 函数

### 4. 分词算法详细链路

#### 4.1 分词核心逻辑
**文件位置**: `app.go` - `SegmentText` 函数

**算法步骤**:
```go
// 1. 初始化
results := []map[string]any{}
i := 0

// 2. 遍历文本
for i < len(text) {
    matched := false

    // 3. 尝试最长匹配 (10个字符以内)
    for length := min(10, len(text)-i); length >= 1; length-- {
        substring := text[i : i+length]
        if english, exists := roots[substring]; exists {
            // 4. 找到匹配，添加到结果
            results = append(results, map[string]any{
                "chinese":  substring,
                "english":  english,
                "isUnknown": false,
            })
            i += length
            matched = true
            break
        }
    }

    // 5. 未匹配字符处理
    if !matched {
        runeValue, size := utf8.DecodeRuneInString(text[i:])
        results = append(results, map[string]any{
            "chinese":  string(runeValue),
            "english":  "",
            "isUnknown": true,
        })
        i += size
    }
}
```

#### 4.2 翻译结果生成
**文件位置**: `app.go` - `TranslateText` 函数

**逻辑**:
- 基于分词结果
- 用下划线连接翻译后的词根
- 未翻译字符保持原样

### 5. 数据库操作链路

#### 5.1 数据库初始化
**文件位置**: `app.go` - `initDB` 函数

**执行时机**: 应用启动时 (`startup` 方法)
**操作**: 创建表和索引

#### 5.2 数据访问模式
所有数据库操作都遵循以下模式：
1. 获取读写锁 (`a.mu.Lock()` / `a.mu.RLock()`)
2. 检查数据库连接状态
3. 执行 SQL 操作
4. 错误处理
5. 释放锁

### 6. 前后端通信链路

#### 6.1 API 绑定生成
**文件位置**: `frontend/wailsjs/go/main/App.d.ts`

**生成机制**: Wails 自动根据 Go 结构体的导出方法生成 TypeScript 接口

#### 6.2 方法调用示例
```typescript
// 前端调用
const result = await GoAPI.TranslateText("中文文本");

// 对应后端方法
func (a *App) TranslateText(text string) (string, error) {
    // 实现逻辑
}
```

### 7. 用户界面交互链路

#### 7.1 标签页切换
**文件位置**: `frontend/src/App.tsx` - 标签页切换逻辑

**状态管理**: `activeTab` 状态控制显示内容
**组件**: `Navigation` 组件处理导航切换

#### 7.2 实时搜索
**文件位置**: `frontend/src/components/management/ManagementPage.tsx` - 搜索过滤逻辑

**实现**: 基于当前搜索词过滤词根列表

#### 7.3 确认对话框
**文件位置**: `frontend/src/components/management/ManagementPage.tsx` - 清空确认对话框逻辑

**模式**: 重要操作前显示确认对话框
**组件**: 使用 `Dialog` 组件显示确认对话框

## 关键数据流图

### 翻译流程数据流
```
用户输入 → 前端解析 → 后端分词 → 数据库查询 → 翻译生成 → 前端显示
     ↓           ↓           ↓           ↓           ↓           ↓
  多行文本   行数组分割   最长匹配算法   词根映射   下划线连接   颜色区分显示
```

### 词根管理数据流
```
用户操作 → 前端处理 → API调用 → 后端验证 → 数据库操作 → 状态更新 → 界面刷新
    ↓         ↓         ↓         ↓         ↓         ↓         ↓
 添加/编辑  参数验证  方法绑定  数据校验  SQL执行  重新加载  实时更新
```

## 错误处理链路

### 前端错误处理
**位置**: 各个异步操作中的 try-catch 块
**策略**: 控制台日志 + 用户提示

### 后端错误处理
**位置**: 所有 Go 方法的错误返回
**策略**: 具体错误信息 + 事务回滚

## 性能关键点

### 1. 分词算法优化
- 最长匹配长度限制为10个字符
- 使用索引加速数据库查询
- 内存中缓存词根数据

### 2. 前端渲染优化
- 虚拟滚动处理大量数据
- 防抖搜索输入
- 组件级别的状态管理
- 模块化组件设计，提高代码复用性和维护性

### 3. 数据库优化
- 使用事务批量操作
- 合适的索引设计
- 连接池管理

## 扩展功能链路

### 自定义词根添加后的重新翻译
**特殊链路**:
```
添加词根 → 数据库更新 → 重新加载词根数据 → 批量重新翻译 → 界面更新
```

### CSV 导入的预览机制
**用户交互链路**:
```
选择文件 → 解析预览 → 用户确认 → 批量导入 → 界面刷新
```

## 8. 组件化架构链路

### 8.1 前端架构设计
**核心原则**: 单一职责、模块化、可复用

**目录结构**:
```
frontend/src/
├── components/
│   ├── common/           # 通用组件
│   │   ├── Header.tsx    # 应用头部
│   │   └── Navigation.tsx # 侧边导航
│   ├── translation/      # 翻译模块
│   │   ├── TranslationPage.tsx   # 翻译主页面
│   │   ├── InputArea.tsx         # 输入区域
│   │   ├── TranslationTable.tsx  # 翻译结果表格
│   │   └── CustomRootForm.tsx    # 自定义词根表单
│   ├── management/       # 管理模块
│   │   ├── ManagementPage.tsx    # 管理主页面
│   │   ├── RootTable.tsx         # 词根表格
│   │   ├── ImportDialog.tsx      # 导入对话框
│   │   └── EditDialog.tsx        # 编辑对话框
│   └── shared/           # 共享组件
│       ├── MixedTranslation.tsx  # 混合翻译组件
│       └── types.ts              # 类型定义
├── hooks/                # 自定义Hooks
│   ├── useRoots.ts       # 词根管理hook
│   ├── useTranslation.ts # 翻译功能hook
│   └── useClipboard.ts   # 剪贴板hook
└── services/             # 服务层
    ├── api.ts            # API调用封装
    └── csv.ts            # CSV处理工具
```

### 8.2 数据流设计

#### 状态管理架构
```
App.tsx (根组件)
├── activeTab: 标签页状态
├── version: 应用版本
└── 子组件通信
    ├── TranslationPage (翻译页面)
    │   ├── useTranslation Hook
    │   ├── useClipboard Hook
    │   └── 子组件状态传递
    └── ManagementPage (管理页面)
        ├── useRoots Hook
        └── 子组件状态传递
```

#### 服务层架构
```
组件层 → Hooks层 → 服务层 → Wails API → Go后端
    ↓       ↓        ↓        ↓        ↓
UI组件  状态管理   API封装  类型绑定  业务逻辑
```

### 8.3 组件通信模式

#### Props传递模式
- 父组件向子组件传递数据和回调函数
- 子组件通过回调函数通知父组件状态变化

#### Hook状态模式
- 使用自定义Hook封装复杂状态逻辑
- 提供清晰的API给组件使用

#### 服务层模式
- 统一管理API调用和工具函数
- 提供类型安全的接口

## 9. 翻译历史功能链路

### 9.1 翻译历史保存链路

#### 9.1.1 自动保存机制
**文件位置**: `frontend/src/components/translation/TranslationPage.tsx` - `handleUnifiedInput` 和 `handleTableEdit` 函数

**保存条件**:
- 翻译完全成功（无未知词根）
- 中文文本非空
- 翻译结果非空

**调用链路**:
```
前端即时翻译 → isTranslationComplete() 检查 → saveTranslationHistory() → 后端数据库保存
```

**实现逻辑**:
```typescript
// 在即时翻译过程中自动保存历史记录
if (translated && line.trim()) {
    const complete = await isTranslationComplete(line);
    if (complete) {
        saveTranslationHistory(line.trim(), translated);
    }
}
```

#### 9.1.2 翻译完整性检查
**文件位置**: `backend/service/translation.go` - `IsTranslationComplete` 方法

**检查逻辑**:
- 对输入文本进行分词
- 检查所有分词片段是否都已翻译
- 如果存在未知词根，返回 false

### 9.2 翻译历史显示链路

#### 9.2.1 历史记录加载
**文件位置**: `frontend/src/components/translation/HistoryPanel.tsx` - `loadHistory` 函数

**调用链路**:
```
组件挂载/刷新 → getTranslationHistory() → 后端数据库查询 → 前端状态更新
```

**实现细节**:
- 按创建时间倒序排列
- 限制显示最近100条记录
- 支持滚动浏览

#### 9.2.2 历史记录复用
**文件位置**: `frontend/src/components/translation/HistoryPanel.tsx` - 点击事件处理

**交互流程**:
```
用户点击历史记录 → onSelectHistory 回调 → 添加到翻译表格 → 即时显示
```

### 9.3 翻译历史管理链路

#### 9.3.1 清空历史记录
**文件位置**: `frontend/src/components/translation/HistoryPanel.tsx` - `confirmClearHistory` 函数

**调用链路**:
```
用户点击删除按钮 → 显示确认对话框 → 用户确认 → clearTranslationHistory() → 后端数据库清空 → 前端状态更新
```

**特殊处理**:
- 使用自定义 Dialog 组件避免 Wails 应用中的浏览器 confirm 兼容性问题
- 立即更新本地状态确保 UI 响应性

#### 9.3.2 状态持久化
**文件位置**: `frontend/src/App.tsx` - 应用级状态管理

**实现机制**:
- 翻译页面状态提升到 App 级别
- 避免切换标签页时丢失翻译内容
- 统一管理翻译输入和表格数据

### 9.4 数据库设计

#### 9.4.1 表结构
**文件位置**: `backend/app/app.go` - `initDB` 函数

**表结构**:
```sql
CREATE TABLE IF NOT EXISTS translation_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    chinese_text TEXT NOT NULL,
    english_text TEXT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_history_created_at ON translation_history(created_at DESC);
```

#### 9.4.2 API 接口
**后端方法**:
- `SaveTranslationHistory(chineseText, englishText string) error`
- `GetTranslationHistory() ([]map[string]any, error)`
- `ClearTranslationHistory() error`
- `IsTranslationComplete(text string) (bool, error)`

**前端服务**:
- `saveTranslationHistory(chineseText: string, englishText: string): Promise<void>`
- `getTranslationHistory(): Promise<TranslationHistoryItem[]>`
- `clearTranslationHistory(): Promise<void>`
- `isTranslationComplete(text: string): Promise<boolean>`

### 9.5 用户界面设计

#### 9.5.1 历史面板布局
**组件位置**: `frontend/src/components/translation/HistoryPanel.tsx`

**布局特点**:
- 右侧侧边栏设计
- 响应式布局（桌面端显示，移动端隐藏）
- 滚动区域支持大量历史记录

#### 9.5.2 交互设计
**用户体验优化**:
- 即时保存，无需用户手动操作
- 质量过滤，只保存完全成功的翻译
- 一键复用，点击即可添加到翻译表格
- 安全删除，确认对话框防止误操作

### 9.6 数据流图

#### 翻译历史保存数据流
```
用户输入 → 即时翻译 → 完整性检查 → 数据库保存 → 历史面板显示
     ↓         ↓           ↓           ↓           ↓
  中文文本  翻译算法  未知词根检测  SQL插入操作  时间倒序排列
```

#### 翻译历史复用数据流
```
用户点击 → 历史记录 → 添加到表格 → 即时显示
    ↓         ↓           ↓           ↓
 交互事件  数据获取  状态更新  界面渲染
```

### 9.7 性能考虑

#### 9.7.1 数据库优化
- 创建时间索引加速排序查询
- 限制历史记录数量（100条）
- 自动清理旧记录

#### 9.7.2 前端优化
- 组件级别的状态管理
- 防抖加载机制
- 滚动区域虚拟化支持

## 10. 输入区域折叠功能链路

### 10.1 折叠状态管理
**文件位置**: `frontend/src/components/translation/InputArea.tsx` - 折叠状态管理

**状态设计**:
```typescript
const [isExpanded, setIsExpanded] = useState(false); // 折叠状态
```

**UI渲染逻辑**:
- **折叠状态**: 显示"快速录入"标题和展开按钮
- **展开状态**: 显示完整输入区域和折叠按钮

### 10.2 翻译流程优化
**文件位置**: `frontend/src/components/translation/TranslationPage.tsx` - `handleBatchTranslate` 函数

**关键改进**:
```typescript
// 翻译结果追加而非替换
const newTableData = [...tableData, ...translatedData];

// 翻译后自动清空输入并折叠
onStateUpdate({
  tableData: newTableData,
  unifiedInput: "" // 清空输入区域
});
```

**用户交互流程**:
```
初始折叠 → 点击展开 → 输入内容 → 点击翻译 → 自动折叠并清空 → 结果追加到表格
```

### 10.3 数据流优化
**文件位置**: `frontend/src/components/translation/InputArea.tsx` - 事件处理函数

**事件处理**:
- **翻译按钮**: 调用翻译逻辑后自动折叠
- **清空按钮**: 清空输入但保持当前展开状态
- **展开/折叠按钮**: 切换折叠状态

### 10.4 向后兼容保证
**设计原则**:
- 所有现有功能完全保持
- 新功能作为增强，不影响现有工作流程
- 数据流保持一致性

**关键文件**:
- `frontend/src/components/translation/InputArea.tsx` - 折叠UI实现
- `frontend/src/components/translation/TranslationPage.tsx` - 翻译逻辑优化

这个功能链路说明详细描述了系统中各个功能模块的实现位置、调用关系和数据处理流程，为后续的功能扩展和维护提供了清晰的指导。