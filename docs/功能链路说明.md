# 金融词根翻译系统 - 功能链路说明

## 功能模块概览

本系统包含两大核心功能模块：
1. **词根翻译模块** - 批量翻译中文金融术语
2. **词根管理模块** - 词根库的增删改查和导入导出

## 核心功能链路详解

### 1. 批量翻译功能链路

#### 1.1 用户输入处理
**文件位置**: `frontend/src/App.tsx:468-478`

**实现逻辑**:
```typescript
const handleUnifiedInput = (value: string) => {
    setUnifiedInput(value);

    if (value.trim()) {
        const lines = value.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        const newData = lines.map(line => ({ chinese: line, english: "" }));
        setTableData(newData);
    } else {
        setTableData([]);
    }
};
```

**数据流**:
用户输入 → 按行分割 → 过滤空行 → 初始化表格数据

#### 1.2 批量翻译执行
**文件位置**: `frontend/src/App.tsx:496-514`

**调用链路**:
```
前端 App.tsx:501 → GoAPI.TranslateText() → 后端 app.go:257 → SegmentText() → TranslateText()
```

**详细流程**:
1. 前端遍历表格中的每一行中文文本
2. 对每行文本调用 `GoAPI.TranslateText()`
3. 后端执行分词和翻译算法
4. 返回翻译结果更新前端界面

#### 1.3 翻译结果显示
**文件位置**: `frontend/src/App.tsx:702`

**组件**: `MixedTranslation` 组件
**功能**: 实时显示翻译结果，绿色表示已翻译，红色表示未翻译

### 2. 词根管理功能链路

#### 2.1 词根数据加载
**文件位置**: `frontend/src/App.tsx:16-24`

**调用链路**:
```
前端 loadCustomRoots() → GoAPI.GetAllRoots() → 后端 app.go:68 → 数据库查询
```

**数据流**:
应用启动 → 加载词根数据 → 缓存到前端状态 → 渲染界面

#### 2.2 添加单个词根
**文件位置**: `frontend/src/App.tsx:529-553`

**调用链路**:
```
前端 handleAddCustomRoot() → GoAPI.AddRoot() → 后端 app.go:95 → 数据库插入
```

**特殊处理**: 添加词根后自动重新翻译所有文本

#### 2.3 批量导入词根
**文件位置**: `frontend/src/App.tsx:107-146` (RootManagement 组件)

**完整流程**:
1. 用户选择 CSV 文件
2. 前端解析 CSV 内容 (`parseCSVAndPreview`)
3. 显示导入预览对话框
4. 用户确认后调用 `GoAPI.ImportRoots()`
5. 后端使用事务批量插入数据

#### 2.4 词根编辑功能
**文件位置**: `frontend/src/App.tsx:152-171`

**特殊逻辑**:
- 如果修改了中文词根，先删除旧的再添加新的
- 确保数据一致性

### 3. 数据导出功能链路

#### 3.1 词根库导出
**文件位置**: `frontend/src/App.tsx:184-213`

**调用链路**:
```
前端 handleExportCSV() → GoAPI.ExportRoots() → 后端 app.go:180 → 生成CSV
```

**实现细节**:
- 后端生成标准 CSV 格式
- 前端创建 Blob 对象并提供下载

#### 3.2 翻译结果导出
**文件位置**: `frontend/src/App.tsx:555-584`

**格式**: TSV (Tab-Separated Values)
**用途**: 方便粘贴到 Excel

### 4. 分词算法详细链路

#### 4.1 分词核心逻辑
**文件位置**: `app.go:209-253`

**算法步骤**:
```go
// 1. 初始化
results := []map[string]any{}
i := 0

// 2. 遍历文本
for i < len(text) {
    matched := false

    // 3. 尝试最长匹配 (10个字符以内)
    for length := min(10, len(text)-i); length >= 1; length-- {
        substring := text[i : i+length]
        if english, exists := roots[substring]; exists {
            // 4. 找到匹配，添加到结果
            results = append(results, map[string]any{
                "chinese":  substring,
                "english":  english,
                "isUnknown": false,
            })
            i += length
            matched = true
            break
        }
    }

    // 5. 未匹配字符处理
    if !matched {
        runeValue, size := utf8.DecodeRuneInString(text[i:])
        results = append(results, map[string]any{
            "chinese":  string(runeValue),
            "english":  "",
            "isUnknown": true,
        })
        i += size
    }
}
```

#### 4.2 翻译结果生成
**文件位置**: `app.go:256-278`

**逻辑**:
- 基于分词结果
- 用下划线连接翻译后的词根
- 未翻译字符保持原样

### 5. 数据库操作链路

#### 5.1 数据库初始化
**文件位置**: `app.go:34-65`

**执行时机**: 应用启动时 (`startup` 方法)
**操作**: 创建表和索引

#### 5.2 数据访问模式
所有数据库操作都遵循以下模式：
1. 获取读写锁 (`a.mu.Lock()` / `a.mu.RLock()`)
2. 检查数据库连接状态
3. 执行 SQL 操作
4. 错误处理
5. 释放锁

### 6. 前后端通信链路

#### 6.1 API 绑定生成
**文件位置**: `frontend/wailsjs/go/main/App.d.ts`

**生成机制**: Wails 自动根据 Go 结构体的导出方法生成 TypeScript 接口

#### 6.2 方法调用示例
```typescript
// 前端调用
const result = await GoAPI.TranslateText("中文文本");

// 对应后端方法
func (a *App) TranslateText(text string) (string, error) {
    // 实现逻辑
}
```

### 7. 用户界面交互链路

#### 7.1 标签页切换
**文件位置**: `frontend/src/App.tsx:607-627`

**状态管理**: `activeTab` 状态控制显示内容

#### 7.2 实时搜索
**文件位置**: `frontend/src/App.tsx:241-244`

**实现**: 基于当前搜索词过滤词根列表

#### 7.3 确认对话框
**文件位置**: `frontend/src/App.tsx:329-352` (清空确认)

**模式**: 重要操作前显示确认对话框

## 关键数据流图

### 翻译流程数据流
```
用户输入 → 前端解析 → 后端分词 → 数据库查询 → 翻译生成 → 前端显示
     ↓           ↓           ↓           ↓           ↓           ↓
  多行文本   行数组分割   最长匹配算法   词根映射   下划线连接   颜色区分显示
```

### 词根管理数据流
```
用户操作 → 前端处理 → API调用 → 后端验证 → 数据库操作 → 状态更新 → 界面刷新
    ↓         ↓         ↓         ↓         ↓         ↓         ↓
 添加/编辑  参数验证  方法绑定  数据校验  SQL执行  重新加载  实时更新
```

## 错误处理链路

### 前端错误处理
**位置**: 各个异步操作中的 try-catch 块
**策略**: 控制台日志 + 用户提示

### 后端错误处理
**位置**: 所有 Go 方法的错误返回
**策略**: 具体错误信息 + 事务回滚

## 性能关键点

### 1. 分词算法优化
- 最长匹配长度限制为10个字符
- 使用索引加速数据库查询
- 内存中缓存词根数据

### 2. 前端渲染优化
- 虚拟滚动处理大量数据
- 防抖搜索输入
- 组件级别的状态管理

### 3. 数据库优化
- 使用事务批量操作
- 合适的索引设计
- 连接池管理

## 扩展功能链路

### 自定义词根添加后的重新翻译
**特殊链路**:
```
添加词根 → 数据库更新 → 重新加载词根数据 → 批量重新翻译 → 界面更新
```

### CSV 导入的预览机制
**用户交互链路**:
```
选择文件 → 解析预览 → 用户确认 → 批量导入 → 界面刷新
```

这个功能链路说明详细描述了系统中各个功能模块的实现位置、调用关系和数据处理流程，为后续的功能扩展和维护提供了清晰的指导。